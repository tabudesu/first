<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>バーコードリーダーを使ってみよう！</title>
</head>
<body>
    <nav>
        <ul>
            <li><a href="index.html">入力画面</a></li>
            <li><a href="table.html">照会画面</a></li>
        </ul>
    </nav>


    <h1>入力画面</h1>
    <p>バーコードリーダーを使用してバーコードを読み取ってください。</p>
    <literal>
    <input type="text" pattern="^[a-zA-Z0-9]+$" maxlength="13" id="input">
    </literal>

    <button type="button" onclick="search()">
        確定
    </button>

    <button type="button" onclick="allclear()">
        クリア
    </button>
    <p id="janError"></p>
    <p>検索結果</p>
    <p>商品名</p><span id="itemName"></span>
    <p>商品名:自動抽出</p><span id="itemName_auto"></span>

    <p>購入価格</p>
    <textarea id="itemPrice"></textarea>
    <button type="button" onclick="search()">
        登録
    </button>

    <script>

        function search() {
            //JAN取得
            const serarhkeyword = document.getElementById("input").value;

            if (serarhkeyword.length == 13) {
                document.getElementById("janError").textContent = null;
                document.getElementById("itemPrice").textContent = null;

                const request = new XMLHttpRequest();
                //アプリケーションID（楽天）
                const applicationId = "1049198666783003336";
                //リクエスト作成
                const requestStr = "https://app.rakuten.co.jp/services/api/IchibaItem/" +
                    "Search/20170706?format=json&keyword=" +
                    serarhkeyword + "&applicationId=" + applicationId;

                request.open('GET', requestStr, true);
                request.responseType = 'json';

                request.onload = function () {
                    const data = this.response;
                    //const from_json = JSON.parse(data);

                    // 確認用
                    console.log(data);

                    if (data.Items.length != 0) {
                        document.getElementById("itemName").textContent = data.Items[0].Item.itemName;

                        //30個格納
                        const ItemNameArray = [];

                        for (let i = 0; i < 30; i++) {
                            ItemNameArray.push(data.Items[i].Item.itemName)
                        }
                        console.log(ItemNameArray)

                        //比較したい
                        for (let i = 0; i < ItemNameArray[0].length; i++) {
                            for (let j = 4; j < ItemNameArray[0].length; j++) {
                                const base = ItemNameArray[0].replace(/\s+/g, "").substr(i, j)
                                try {
                                    if ((ItemNameArray[1].replace(/\s+/g, "").match(base))) {
                                        var result = (ItemNameArray[1].replace(/\s+/g, "").match(base))
                                        console.log(result)
                                    }
                                    else {
                                        break;
                                    }
                                } catch (e) {

                                }
                            }
                            if (result)
                                break;
                        }
                        document.getElementById("itemName_auto").textContent = result;
                    }
                    else {
                        document.getElementById("itemName").textContent = "該当商品がありません"
                    }

                };

                request.send();
            }
            else {
                document.getElementById("itemName").textContent = null;
                document.getElementById("itemPrice").textContent = null;
                document.getElementById("janError").textContent = "JANコードの桁数が間違っています"
            }

        }

        function allclear() {
            document.getElementById("input").value = null;
            document.getElementById("itemName").textContent = null;
            document.getElementById("itemPrice").textContent = null;
            document.getElementById("janError").textContent = null;
            document.getElementById("itemName_auto").textContent = null;
        }

    </script>
</body>
</html>
